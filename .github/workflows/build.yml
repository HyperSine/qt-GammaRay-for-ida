name: GammaRay Build

on: [push]

jobs:
  qt_build_test:
    runs-on: windows-2016
    steps:
      - name: Install jom
        shell: powershell
        run: |
          Set-Location D:\
          Invoke-WebRequest 'http://download.qt.io/official_releases/jom/jom.zip' -OutFile .\jom.zip
          Expand-Archive .\jom.zip
          Remove-Item .\jom.zip
          Get-ChildItem $(pwd)
          Get-ChildItem .\jom
      - name: Clone Qt 5.6.3
        shell: cmd
        run: |
          cd D:\
          mkdir .\Qt\src\
          cd .\Qt\src\
          git clone -b v5.6.3 https://code.qt.io/qt/qt5.git 5.6.3
          cd .\5.6.3
          git submodule update --init --recursive
      - name: Clone latest GammaRay
        shell: cmd
        run: |
          cd D:\
          git clone https://github.com/KDAB/GammaRay.git
      - name: Build Qt 5.6.3 and GammaRay
        shell: cmd
        run: |
          cd D:\
          mkdir .\Qt\build\5.6.3

          call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" amd64
          set _ROOT=D:\Qt\build\5.6.3
          set PATH=%_ROOT%\qtrepotools\bin;%_ROOT%\qtbase\bin;%_ROOT%\gnuwin32\bin;%PATH%
          set QMAKESPEC=win32-msvc2015
          set _ROOT=

          cd .\Qt\build\5.6.3
          D:\Qt\src\5.6.3\configure.bat -release -nomake tests -nomake examples -qtnamespace QT -confirm-license -accessibility -opensource -platform win32-msvc2015 -opengl desktop -prefix .\
          D:\jom\jom.exe -j%NUMBER_OF_PROCESSORS%
          nmake install

          cd D:\
          mkdir artifacts
          
          cd D:\GammaRay\
          mkdir .\build
          cd .\build
          cmake -G "NMake Makefiles" "-DCMAKE_BUILD_TYPE=Release" "-DCMAKE_PREFIX_PATH=D:\Qt\build\5.6.3" "-DCMAKE_INSTALL_PREFIX=D:\artifacts" ..
          nmake
          nmake install
      - name: Copy Qt DLLs
        shell: powershell
        run: |
          $env:Path = "D:\Qt\build\5.6.3\qtbase\bin;" + $env:Path

          foreach ($_ in Get-ChildItem "D:\artifacts\bin" -Include *.exe,*.dll -Recurse) {
              & "D:\Qt\build\5.6.3\qtbase\bin\bin\windeployqt.exe" --release $_
          }
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: qt-GammaRay-x64-for-ida.zip
          path: D:\artifacts
